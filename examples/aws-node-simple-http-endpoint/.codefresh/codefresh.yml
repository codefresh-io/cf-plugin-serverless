version: '1.0'

steps:

  setup:
    image: alpine:3.7
    title: generate AWS shared credentials file
    commands:
      - mkdir -p .aws
      - echo -n $AWS_CREDENTIALS_FILE | base64 -d > ${PWD}/.aws/credentials
      - cf_export AWS_SHARED_CREDENTIALS_FILE=${PWD}/.aws/credentials

  test:
    image: node:9-alpine
    title: test service
    working_directory: ${{main_clone}}/examples/aws-node-simple-http-endpoint
    commands:
      - yarn
      - yarn lint
      - yarn test

  init_staging:
    image: alpine:3.7
    title: setup deployment environment
    commands:
      - cf_export REGION=eu-west-1
      - cf_export STAGE=staging
      - cf_export PROFILE=develop
      - cf_export PACKAGE=.serverles.staging
    when:
      branch:
        ignore:
          - master

  init_production:
    image: alpine:3.7
    title: setup deployment environment
    commands:
      - cf_export REGION=eu-central-1
      - cf_export STAGE=production
      - cf_export PROFILE=devops
      - cf_export PACKAGE=.serverles.production
    when:
      branch:
        only:
          - master

  package:
    image: codefresh/serverless:1.27
    title: package service
    working_directory: ${{main_clone}}/examples/aws-node-simple-http-endpoint
    commands:
      - serverless package --stage ${STAGE} --region ${REGION} --package ${PACKAGE}

  deploy:
    image: codefresh/serverless:1.27
    title: deploy service
    working_directory: ${{main_clone}}/examples/aws-node-simple-http-endpoint
    commands:
      - serverless deploy --stage ${STAGE} --region ${REGION} --conceal --verbose --aws-profile ${PROFILE}
      # failed to deploy from package - need to take a deeper look
