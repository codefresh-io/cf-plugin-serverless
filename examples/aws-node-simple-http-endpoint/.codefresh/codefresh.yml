version: '1.0'

steps:

  setup:
    image: alpine:3.7
    title: generate AWS shared credentials file
    commands:
      - mkdir -p .aws
      - echo -n $AWS_CREDENTIALS_FILE | base64 -d > ${PWD}/.aws/credentials
      - cf_export AWS_SHARED_CREDENTIALS_FILE=${PWD}/.aws/credentials

  init_staging:
    image: alpine:3.7
    title: configure staging deployment environment
    commands:
      - cf_export AWS_REGION=eu-west-1
      - cf_export AWS_STAGE=staging
      - cf_export AWS_PROFILE=develop
      - cf_export PACKAGE=.serverless.staging
    when:
      branch:
        ignore:
          - master

  init_production:
    image: alpine:3.7
    title: configure production deployment environment
    commands:
      - cf_export AWS_REGION=eu-central-1
      - cf_export AWS_STAGE=production
      - cf_export AWS_PROFILE=devops
      - cf_export PACKAGE=.serverless.production
    when:
      branch:
        only:
          - master

  package:
    image: codefresh/serverless:1.27
    title: package serverless service
    working_directory: ${{main_clone}}/examples/aws-node-simple-http-endpoint
    commands:
      - serverless package --stage ${AWS_STAGE} --region ${AWS_REGION} --package ${PACKAGE}


  deploy:
    image: codefresh/serverless:1.27
    title: deploy to AWS with serverless framework
    working_directory: ${{main_clone}}/examples/aws-node-simple-http-endpoint
    commands:
      - serverless deploy --conceal --verbose --stage ${AWS_STAGE} --region ${AWS_REGION} --aws-profile ${AWS_PROFILE} --package ${PACKAGE}